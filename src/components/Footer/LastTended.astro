---
import { Icon } from "@components";
import { format, formatDistanceToNow } from "date-fns";
import * as styles from "./footer.css";

// Vercel Access Token
const accessToken =
  import.meta.env.VERCEL_ACCESS_TOKEN ?? process.env.VERCEL_ACCESS_TOKEN;

// Fetch evadecker.com Vercel project
const projectId = "prj_pMk8EbUuHxsj51ERiVXZyANy9ZPC";
// Fetch only READY deploys
const state = "READY";
// Fetch only production deploys
const target = "production";

let timestamp: string;
let relativeTimeInWords: string;
try {
  // https://vercel.com/docs/rest-api/endpoints#list-deployments
  const response = await fetch(
    `https://api.vercel.com/v6/deployments?projectId=${projectId}&state=${state}&target=${target}`,
    {
      method: "GET",
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    }
  );

  const data = await response.json();

  const { ready } = data.deployments[0];

  timestamp = format(ready, "yyyy-MM-dd HH:mm");
  relativeTimeInWords = formatDistanceToNow(ready, { addSuffix: true });
} catch (error) {
  timestamp = "";
  relativeTimeInWords = "at some point in time";
}
---

<div class={styles.lastTended}>
  <Icon icon="seedling" size="small" className={styles.lastTendedIcon} />
  <small
    >Last tended <time datetime={timestamp}>{relativeTimeInWords}</time></small
  >
</div>
